## Отчет по лабораторной работе №2
**Группа ИС-21, Мавлютов Р. Э.**

 *1. Утилиты резервного копирования*
 
> `pg_dump` является методом бекапа при котором сохраняются SQL команды для воссоздания данных и структур БД.  
> `pg_basebackup` в свою очередь сохраняет физическую копию существующих файлов БД, что более эффективно для крупных систем.

 *2. Создание резервной копии*

> `-Fp` Создает SQL-скрипт, который можно восстановить с помощью psql  
> `-Fc` Создает дамп в специальном формате, который можно восстановить только с помощью pg_restore. Сжимает файлы и позволяет восстановить данные выборочно. `-Fd` - параллельный.  
> `-Ft` Создает дамп в формате tar-архива.  
> `-Z` Позволяет указать уровень сжатия (от 0 до 9).  
> `-s` Экспортирует только схемы, `-a` только данные, `-n` только конкретную схему, `-t` только таблицу.    
> `--no-owner` игнорирует владельцев, `--no-privileges` игнорирует права.  
> `-j` Позволяет выполнять дамп параллельно (только с форматом -Fd — directory)  
> Была выполнена резервная копия в SQL формате.
> <img src="/Lab 2/screens/1.png" title="Создание резервной копии" width="auto" height="592.5"/> 

 *3. Частичное (выборочное) резервное копирование*

> Были проведены резевные копии отдельно схемы и отдельно таблицы. Разница с полным копированием состоит в том, что некоторые зависимости могут быть утеряны, ведь они не связаны с необходимыми элементами, которые есть в полном бэкапе.  
> 
> <img src="/Lab 2/screens/2.png" title="Частичное (выборочное) резервное копирование" width="auto" height="592.5"/>

 *4. Восстановление из резервной копии*

> Для демонстрации восстановления была создана пустая БД db_to_restore. После ее создания была выполнена команда восстановления через psql, а затем отображение результатов в виде востановленных данных из dbmavlyutovre.  
> 
> <img src="/Lab 2/screens/3.png" title="Восстановление из резервной копии" width="auto" height="592.5"/> 
> <img src="/Lab 2/screens/4.png" title="Восстановление из резервной копии" width="auto" height="592.5"/>

 *5. Автоматизация бэкапов с помощью cron*

> Был создан shell скрипт, выполняющий команду дампа с указанием директории, а также команду удаления файлов, первышающих указанную в переменной времени от создания файла. (ротация)  
> Планировщик cron был настроен на выполнение команды каждые 2 минуты и логгирование выполнения в файл лога.
>
> <img src="/Lab 2/screens/5.png" title="Автоматизация бэкапов с помощью cron" width="auto" height="592.5"/>

 *6. Мониторинг состояния системы*

> Был вызван монитринг ресурсов для postgre командой `htop -u postgre`  
> `a) PID` Идентификатор процесса (Process ID).  
> `b) USER` Пользователь, от имени которого запущен процесс.  
> `c) PRI` Приоритет процесса (Priority).  
> `d) NI` Значение "nice" (приоритет процесса, заданный пользователем).  
> `e) VIRT` Виртуальная память, выделенная процессу.  
> `f) RES` Физическая память (RAM), используемая процессом.  
> `g) SHR` Общая память (shared memory), используемая процессом.  
> `h) S`  
>     Состояние процесса:  
> ____`R :` Выполняется (Running).  
> ____`S :` Спит (Sleeping).  
> ____`D :` Ожидает завершения операций ввода/вывода (Disk Sleep).  
> ____`Z :` Зомби-процесс (неактивный процесс, ожидающий завершения родительского процесса).  
> ____`T `: Остановлен (Stopped).  
> `i) %CPU` Процент использования CPU процессом.  
> `j) %MEM` Процент использования оперативной памяти (RAM) процессом.  
> `k) TIME+` Общее время, затраченное процессором на выполнение процесса.  
> `l) COMMAND` Команда, которая запустила процесс.  
>    Например, для PostgreSQL это будет что-то вроде /usr/lib/postgresql/14/bin/postgres.`
>
> <img src="/Lab 2/screens/6.png" title="Мониторинг состояния системы" width="auto" height="592.5"/>

 *7. Мониторинг PostgreSQL*

> Был вызван мониторинг состояния процессов postgre
>
> <img src="/Lab 2/screens/7.png" title="Мониторинг PostgreSQL" width="auto" height="592.5"/>
>
> Мониторинг статистики по базам данных
>
> <img src="/Lab 2/screens/8.png" title="Мониторинг PostgreSQL" width="auto" height="592.5"/>
>
> Взаимодействие с командами происходит как в обычной базе данных, со всеми стандартными SQL запросами.  
> Так, мы можем найти нужный нам процесс, отсортировав по возрастанию задержки и удалить его следующими командами:  
> `SELECT pid, usename, datname, state, query, age(clock_timestamp(), query_start) AS runtime`  
> `FROM pg_stat_activity`  
> `WHERE state = 'active'`  
> `ORDER BY runtime DESC;`  
>
> `SELECT pg_terminate_backend(найденный pid);`

 *8. Логирование и анализ логов*

> PostgreSQL  логгирует события, связанные с выполнением запросов, ошибками, контрольными точками и другими внутренними процессами.  
> Операционная система  логгирует события, связанные с запуском/остановкой службы PostgreSQL, ошибками службы, проблемами с памятью, событиями ядра и безопасности.  
> Логи PostgreSQL находятся в дирктории data/log, где - data это основная директория с бд и файлом конфига. Системные логи — в /var/log/ или же доступны по команде `journalctl`  
> Был открыт `journalctl` и стандартный лог postgre:
>
> <img src="/Lab 2/screens/9.png" title="Логирование и анализ логов" width="auto" height="592.5"/>
